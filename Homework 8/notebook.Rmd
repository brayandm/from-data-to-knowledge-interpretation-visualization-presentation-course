---
title: "Homework 8"
author: "Brayan Duran Medina"
output: html_document
---

## CONSOLIDATION EXERCISE 1: HEXABIN MAP

In folder CONSOLIDATION_EX1 you will find a shapefile with the delimitation by neighborhoods of the municipality 
of Madrid, a shapefile with the municipal delimitation of Madrid and a shapefile with the locations of bars in 
Madrid as recorded in Open Street Maps. Your tasks are:

1 - To read these 3 shapefiles into R.

2 - Do these files share the same CRS? Whatever is the case, transform everything to CRS = 4326.

3 - Create an hexabin map using the location of the bars. Use a map tile for your final map and add two or 
three labels indicating the neighborhoods we must visit the next time we are in Madrid in case we want
 to have a handful of bars around. Save your final map as an image.

```{r, cache=TRUE}
library(sf)
library(sp)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(ggmap)
library(raster)
library(hexbin)
library(RColorBrewer)
library(grid)
library(gridExtra)
```

```{r, cache=TRUE, results='hide'}
shapefile_folder <- "data1"

neighborhoods <- st_read(file.path(shapefile_folder, "Barrios_madrid.shp"))
madrid_municipality <- st_read(file.path(shapefile_folder, "Madrid_ETRS89.shp"))
bars <- st_read(file.path(shapefile_folder, "bars_madrid_municipality.shp"))
```

```{r, cache=TRUE}
ggplot() +
  geom_sf(data = madrid_municipality, fill = "white", color = "black") +
  geom_sf(data = neighborhoods, fill = "transparent", color = "black") +
  geom_sf(data = bars, color = "red") +
  theme_minimal()
```

```{r, cache=TRUE}
if (st_crs(neighborhoods) != st_crs(4326)) {
  neighborhoods <- st_transform(neighborhoods, 4326)
}

if (st_crs(madrid_municipality) != st_crs(4326)) {
  madrid_municipality <- st_transform(madrid_municipality, 4326)
}

if (st_crs(bars) != st_crs(4326)) {
  bars <- st_transform(bars, 4326)
}
```

```{r, cache=TRUE} 
stadia_api_key <- "9929b39d-4ff6-49b3-a0d8-244eb95edbbb"
register_stadiamaps(stadia_api_key)

hex_grid <- st_make_grid(bars, cellsize = c(0.003, 0.003), what = "polygons", square = FALSE)
hex_grid_sf <- st_sf(hex_grid) %>%
  mutate(grid_id = 1:length(lengths(hex_grid)))

hex_grid_sf$pt_count <- lengths(st_intersects(hex_grid_sf, bars))
hex_grid_sf$pt_count <- ifelse(hex_grid_sf$pt_count == 0, NA, hex_grid_sf$pt_count)

myColors <- c("#BFBFBF", rev(brewer.pal(7, "Spectral")))

hex_extent <- st_bbox(hex_grid_sf)

bbox_values <- c(left = hex_extent["xmin"], bottom = hex_extent["ymin"], right = hex_extent["xmax"], top = hex_extent["ymax"])

madrid_map <- get_stadiamap(bbox = c(left = -3.799859, bottom = 40.341650, right = -3.564859, top = 40.537949), zoom = 13, maptype = "stamen_toner_lite")

ggmap(madrid_map)
ggmap_bbox <- attr(madrid_map, 'bb')

head(neighborhoods)

neighborhoods_centroids <- st_centroid(neighborhoods)

labels <- neighborhoods_centroids %>% filter(NOMBRE %in% c("Universidad", "Embajadores"))

MAP4 <- ggplot() +
  annotation_custom(rasterGrob(madrid_map, width=unit(1,"npc"), height=unit(1,"npc")), 
                    xmin=ggmap_bbox$ll.lon, xmax=ggmap_bbox$ur.lon, 
                    ymin=ggmap_bbox$ll.lat, ymax=ggmap_bbox$ur.lat) +
  geom_sf(data = hex_grid_sf, aes(fill = pt_count), colour = "black", linewidth = .025) +
  geom_sf(data = madrid_municipality, fill = NA, colour = "black", linewidth = 0.5) +
  geom_label(data = as.data.frame(labels), 
             aes(x = st_coordinates(labels)[,1], y = st_coordinates(labels)[,2], label = NOMBRE), 
             size = 2, color = "black", fill = "white", fontface = "bold", label.padding = unit(0.25, "lines"), 
             label.size = 0.5, label.r = unit(0.15, "lines"), 
             nudge_x = 0.03) +
  scale_fill_distiller(palette = "Spectral", name = "Number of bars", na.value = "transparent") +
  coord_sf(xlim = c(hex_extent["xmin"], hex_extent["xmax"]), ylim = c(hex_extent["ymin"], hex_extent["ymax"]), expand = FALSE) +
  labs(
    x = "\nLongitude",
    y = "Latitude\n",
    title = "Hexabin Map of Bars in Madrid 2023",
    subtitle = "Number of bars in Madrid by neighborhood"
  ) +
  theme(
    legend.position = "right",
    plot.title = element_text(lineheight = 1, size = 10, face = "bold"),
    plot.subtitle = element_text(vjust = 0.5, size = 8, colour = "black"),
    plot.caption = element_text(vjust = 0.5, size = 6, colour = "black"),
    legend.title = element_text(angle = 0, vjust = 0.5, size = 8, colour = "black", face = "bold"),
    legend.text = element_text(vjust = 0.5, size = 8, colour = "black"),
    axis.line = element_blank(),
    axis.text.x = element_blank(), axis.title.x = element_blank(),
    axis.text.y = element_blank(), axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )

ggsave("hexabin_map_bars_madrid.png", plot = MAP4, width = 10, height = 8)

print(MAP4)
```

## CONSOLIDATION EXERCISE 2: MARE NOSTRU MARE MORTUM
In the folder CONSOLIDATION_EX2 you will find the file Missing_Migrants.xlsx, please read it into R and perform the following tasks. HINT: library(readxl); data <- read_excel()

1 - Filter cases where “Region_Incident” is equal to Mediterranean.

2 - Drop those cases where “Coordinates” is equal to NA. Hint: drop_na()

3 - To need to separate the coordinates into two columns. You can use the following expression:

```
# medi$lon<-as.numeric(sub("^.*?,", "",  medi$Coordinates))
# medi$lat<-as.numeric(gsub(",.*$", "", medi$Coordinates))
```

4 - Change the name of column 8 to “deaths”. Hint: colnames().

5 - Drop those cases where deaths is equal to NA.
6 - Filter cases deaths >0.

7 - Create categories for deaths as the ones in the map below.

8 - Convert your dataframe to a sf object. Hint:st_as_sf

9 - Get a map of the world. Hint: giscoR.

```
library(giscoR)
res <- "03"
target_crs <- 4326
world <- gisco_get_countries(
  resolution = res, region = NULL,
  epsg = target_crs
)
```

10 - Plot a bubble map as the one below. It’s not mandatory to replicate the aesthetics of the map below.

```{r, cache=TRUE}
library(readxl)
library(dplyr)
library(tidyr)
library(sf)
library(giscoR)
library(ggplot2)

data <- read_excel("data2/Missing_Migrants.xlsx")

data_filtered <- data %>% filter(Region_Incident == "Mediterranean")

data_filtered <- data_filtered %>% drop_na(Coordinates)

data_filtered <- data_filtered %>%
  mutate(lon = as.numeric(sub("^.*?,", "", Coordinates)),
         lat = as.numeric(gsub(",.*$", "", Coordinates)))

colnames(data_filtered)[8] <- "deaths"

data_filtered <- data_filtered %>% drop_na(deaths)

data_filtered <- data_filtered %>% filter(deaths > 0)

data_filtered <- data_filtered %>%
  mutate(deaths_category = case_when(
    deaths <= 5 ~ "<=5",
    deaths <= 25 ~ "[5-25]",
    deaths <= 50 ~ "[25-50]",
    deaths <= 100 ~ "[50-100]",
    deaths <= 250 ~ "[100-250]",
    deaths > 250 ~ ">250"
  ))

data_filtered$deaths_category <- factor(data_filtered$deaths_category, levels = c("<=5", "[5-25]", "[25-50]", "[50-100]", "[100-250]", ">250"))

data_sf <- st_as_sf(data_filtered, coords = c("lon", "lat"), crs = 4326)

res <- "03"
target_crs <- 4326
world <- gisco_get_countries(
  resolution = res, region = NULL,
  epsg = target_crs
)

plot <- ggplot() +
  geom_sf(data = world, fill = "lightgray", color = "white") +
  geom_sf(data = data_sf, aes(size = deaths_category), color = "red", fill = "red", alpha = 0.2) +
  scale_size_manual(values = c("<=5" = 1, "[5-25]" = 3, "[25-50]" = 5, "[50-100]" = 7, "[100-250]" = 9, ">250" = 11), name = "Deaths") +
  theme_minimal(base_family = "Arial") +
  coord_sf(xlim = c(-10, 40), ylim = c(25, 50), expand = FALSE) +
  labs(title = "Mare Nostrum / Mare Mortum", 
       subtitle = "Between 2014 and 2023, 10,000 people have died in the Mediterranean",
       x = "Longitude", y = "Latitude") +
  theme(
    plot.background = element_rect(fill = "black", color = NA),
    panel.background = element_rect(fill = "black", color = NA),
    plot.title = element_text(color = "white", size = 14, hjust = 0.5),
    plot.subtitle = element_text(color = "white", size = 10, hjust = 0.5),
    axis.title = element_text(color = "white"),
    axis.text = element_text(color = "white"),
    legend.background = element_rect(fill = "black", color = NA),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    panel.grid = element_line(color = "black"),
    panel.border = element_blank()
  )


print(plot)

ggsave("bubble_map_missing_migrants.png", plot = plot, width = 10, height = 8)
```

## CONSOLIDATION EXERCISE 3: CARTOGRAMS.
Find the materials for this exercise in folder CONSOLIDATION_EX3.

1 - Read shapefile world into R.

2 - Read csv file births into R.

3 - Format variable iso_n3 in births so it has the same format as in world. Hint: use function sprintf(“%.3d”,df$variable)

4 - Join data from births to sf world.

5 - Replace NAs in variable births with value 100.

6 - Replace NAs in variable gdp_md_est with value 10.

7 - Create three different cartograms using variables Births, pop_est and gdp_md_est. Set argument itermax equal to 7 
in all cases.

8 - Add a new column called facets to sf world and to the the three cartograms. In each sf set its corresponding label:
 world, Births, Population and GDP estimate. Row bind sf world and your three cartograms. Create a facet map using
  variable continent as fill variable and save it as an image.

```{r, cache=TRUE} 
library(sf)
library(dplyr)
library(cartogram)
library(ggplot2)

world <- st_read("data3/world.shp")

births <- read.csv("data3/births.csv")

births$iso_n3 <- sprintf("%.3d", births$iso_n3)

head(births)
head(world)

world <- left_join(world, births, by = c("iso_n3"))

world$Births[is.na(world$Births)] <- 100

world$gdp_md_est[is.na(world$gdp_md_est)] <- 10

world <- st_transform(world, crs = "+proj=robin")

cartogram_births <- cartogram_cont(world, "Births", itermax = 7)
cartogram_pop <- cartogram_cont(world, "pop_est", itermax = 7)
cartogram_gdp <- cartogram_cont(world, "gdp_md_est", itermax = 7)

world$facets <- "World"
cartogram_births$facets <- "Births"
cartogram_pop$facets <- "Population"
cartogram_gdp$facets <- "GDP Estimate"
combined <- rbind(world, cartogram_births, cartogram_pop, cartogram_gdp)

plot <- ggplot(data = combined) +
  geom_sf(aes(fill = continent)) +
  facet_wrap(~facets) +
  theme_minimal() +
  labs(title = "Facet Map of the World and Cartograms",
       fill = "Continent") +
  theme(legend.position = "bottom")

print(plot)

ggsave("facet_map.png", plot = plot, width = 20, height = 10)
```