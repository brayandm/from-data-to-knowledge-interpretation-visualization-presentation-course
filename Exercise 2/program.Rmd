---
title: "Homework 2"
author: "Brayan Duran Medina"
output: html_document
---

# Load the necessary packages

```{r, results="hide", message=FALSE, warning=FALSE}
install_and_load <- function(packages) {
  new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
  if (length(new_packages)) install.packages(new_packages)
  sapply(packages, require, character.only = TRUE)
}

packages_needed <- c("dplyr", "tidyr", "readxl")

install_and_load(packages_needed)

library(dplyr)
library(tidyr)
library(readxl)
```

# Load the data

```{r}
file_path <- "data-denmark.xlsx"
deaths_data <- read_excel(file_path, sheet = "deaths")
pop_data <- read_excel(file_path, sheet = "pop")
```

# Ex 1. Using deaths data from Denmark answer the following question:

# Q: Which region had the largest number of deaths among men in the year 2003?

```{r}
deaths_2003_men <- deaths_data %>%
  filter(year == "y2003" & sex == "m")

deaths_2003_men <- deaths_2003_men %>%
  group_by(region) %>%
  summarise(total_deaths = sum(value)) %>%
  arrange(desc(total_deaths))

print(paste("The region with the largest number of deaths among men in 2003 was", deaths_2003_men$region[1], "with", deaths_2003_men$total_deaths[1], "deaths."))
```

# Ex 2. Using pop data from Denmark answer the following question:

# Q: In which region the sex ration (SR) is highest at ages 15, 45, over75 (coded as "open") in the year 2004?

```{r}
pop_2004 <- pop_data %>%
  filter(year == "y2004")

pop_2004_wide <- pop_2004 %>%
  pivot_wider(names_from = sex, values_from = value)

pop_2004_wide <- pop_2004_wide %>%
  select(-b)

pop_2004_wide <- pop_2004_wide %>%
  mutate(sex_ratio = m / f * 100)

ages <- c("a15", "a45", "open")

highest_sex_ratios <- pop_2004_wide %>%
  filter(age %in% ages) %>%
  group_by(age) %>%
  summarise(region = region[which.max(sex_ratio)],
            sex_ratio = max(sex_ratio, na.rm = TRUE))

print(paste("The region with the highest sex ratio at age 15 is", highest_sex_ratios$region[1], "with a ratio of", highest_sex_ratios$sex_ratio[1]))
print(paste("The region with the highest sex ratio at age 45 is", highest_sex_ratios$region[2], "with a ratio of", highest_sex_ratios$sex_ratio[2]))
print(paste("The region with the highest sex ratio at age over 75 is", highest_sex_ratios$region[3], "with a ratio of", highest_sex_ratios$sex_ratio[3]))
```

# Ex 3. Joined dataframe. Perform the following tasks:

- Join the two dataframes (left_join OR inner_join) into a new one called df.
- Remove rows where age is equal to total.
- Change the names of columns value.x and value.y to pop and deaths.
- Convert column age to a number (Note: open = 75). Hint: substr and if_else.
- Calculate the Age Specific Death Ratios in a column called ASDR. Hint: mutate.

# Now that you have df filter only the ages 15-59 and year 2001 and answer the following question:

# Q: Which is the average ratio of male ASDR to female ASDR in each region?

```{r}
df <- left_join(deaths_data, pop_data, by = c("year", "region", "sex", "age"))

df <- df %>%
  filter(age != "total")

df <- df %>%
  rename(pop = value.y, deaths = value.x)

df <- df %>%
  mutate(age = if_else(age == "open", 75, as.numeric(substr(age, 2, nchar(age)))))

df <- df %>%
  mutate(ASDR = deaths / pop)

df <- df %>%
  select(-deaths, -pop)

df_filtered <- df %>%
  filter(age >= 15 & age <= 59 & year == "y2001")

df_ratio <- df_filtered %>%
  pivot_wider(names_from = sex, values_from = ASDR) %>%
  mutate(ASDR_ratio = m / f) %>%
  mutate(ASDR_ratio = na_if(ASDR_ratio, Inf)) %>%
  group_by(region) %>%
  summarise(average_ratio = mean(ASDR_ratio, na.rm = TRUE))

print("Average ratio of male ASDR to female ASDR in each region (ages 15-59, year 2001):")
print(df_ratio)
```