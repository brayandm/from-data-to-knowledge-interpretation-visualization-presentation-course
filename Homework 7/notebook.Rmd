---
title: "Homework 7"
author: "Brayan Duran Medina"
output: html_document
---

# CONSOLIDATION EXCERCISE 1: choropleth maps

1 - Read “violence_women.csv” file into R.

2 - Join the csv data to your world sf object.

3 - Replace NA values in column value with zeros. Hint:

shp_violence$Value[is.na(shp_violence$Value)] <- 0

4 - Create some pretty breaks for your data, as the ones in the image below. Equal 0 to No Data.

5 - Create a color palette for your map and plot in showing only the cases of Europe, as in the image below.

6 - Save your map as an image.

```{r, cache=TRUE}
library(tidyverse)
library(giscoR)
library(sf)
library(classInt)
library(ggplot2)
library(RColorBrewer)

violence_w <- read.csv("data/violence_women.csv")

res <- "03"
target_crs <- 4326
world <- gisco_get_countries(resolution = res, epsg = target_crs)
world <- left_join(world, violence_w, by = c("ISO3_CODE" = "ISO3_CODE"))

world$Value[is.na(world$Value)] <- 0

breaks <- c(-0.01, 0, 10, 15, 20, 25, 30, 35, 100)
labels <- c("No Data", "<10%", "10-15%", "15-20%", "20-25%", "25-30%", "30-35%", ">35%")

palette <- brewer.pal(n = 7, name = "YlOrRd")

europe_map <- ggplot(data = world) +
  geom_sf(aes(fill = cut(Value, breaks = breaks, labels = labels, include.lowest = TRUE)), color = "black") +
  scale_fill_manual(values = c("gray50", palette), na.value = "gray50", name = "Violence against Women") +
  labs(title = "Prevalence of Lifetime Violence against Women in Europe 2020", subtitle = "Data Source: violence_women.csv") +
  theme_minimal() +
  coord_sf(xlim = c(-15, 45), ylim = c(30, 70), expand = FALSE)

print(europe_map)

ggsave("Europe_Violence_Against_Women_Map.png", plot = europe_map, width = 10, height = 10)
```

# CONSOLIDATION EXCERCISE 2: heatmaps

File AIRBNB_BCN.Rdata contains information about the AirBnB offers in the city of Barcelona. bcn_districts.shp is a shapefile with the delimitation by districts of Barcelona.

1 - Read both files into R and answer the following questions: Do this sf object have the same CRS? Act in consequence.

2 - Produce a heatmap with the location of the airbnb accomodations.

3 - Add a map tile as map background and the delimitation of the districts.

4 - Focus the final map on the city centre, as shown in the map below.

5 - Save your map as an image.

```{r, cache=TRUE}
library(sf)
library(ggplot2)
library(dplyr)
library(prettymapr)
library(ggspatial)
library(ggmap)

load("data/AIRBNB_BCN.Rdata")
bcn_districts <- st_read("data/bcn_districts.shp")

airbnb_sf <- st_as_sf(AIRBNB_BCN, coords = c("longitude", "latitude"), crs = 4326)

if (st_crs(bcn_districts) != st_crs(airbnb_sf)) {
  bcn_districts <- st_transform(bcn_districts, st_crs(airbnb_sf))
}

stadia_api_key <- ""
register_stadiamaps(stadia_api_key)

bcn_map <- get_stadiamap(bbox = c(left = 2.10, bottom = 41.36, right = 2.25, top = 41.43), zoom = 13, maptype = "stamen_toner_lite")

heatmap <- ggmap(bcn_map) +
  stat_density2d(
    aes(x = st_coordinates(airbnb_sf)[,1], y = st_coordinates(airbnb_sf)[,2], fill = ..level..),
    geom = "polygon",
    data = as.data.frame(st_coordinates(airbnb_sf)),
    alpha = 0.3,  
    inherit.aes = FALSE
  ) +
  scale_fill_gradient(low = "blue", high = "red") +
  geom_sf(data = bcn_districts, fill = NA, color = "black", size = 0.5, inherit.aes = FALSE) +
  geom_sf_text(data = bcn_districts, aes(label = NOM), size = 5, color = "black", inherit.aes = FALSE, 
               bg.color = "white", bg.r = 0.1) +
  labs(title = "AIRBNB Accomodations in Barcelona 2022",
       x = "Longitude", y = "Latitude") +
  theme(plot.title = element_text(size = 16, face = "bold"))

print(heatmap)

ggsave("AirBnB_Heatmap_Barcelona.png", plot = heatmap, width = 10, height = 8)
```