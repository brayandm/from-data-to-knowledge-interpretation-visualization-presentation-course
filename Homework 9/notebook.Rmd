---
title: "Homework 9"
author: "Brayan Duran Medina"
output: html_document
---

## CONSOLIDATION EXERCISE: geocoding information and getting routes.
Please get the long/lat coordinates of the following places:

Harbour Space, Campus Barcelona La Sagrada Familia El Camp Nou (FC Barcelona Stadium) Casa Batllo

Your task is to compute de distance by car and foot from Harbour Space to each of the 3 location 
and to visualize that information into a map.

```{r}
library(tidyverse)
library(sf)
library(ggmap)
library(osmdata)
library(tidygeocoder)
library(osrm)
library(gridExtra)
```

```{r, cache=TRUE}
stadia_api_key <- "60fc6640-0800-4609-a115-d08320f7665f"
register_stadiamaps(stadia_api_key)

locations <- tibble(
  name = c("Harbour Space, Campus Barcelona", "La Sagrada Familia", "El Camp Nou", "Casa Batllo"),
  lat = c(41.39058154071101, 41.403625339102646, 41.38089518399371, 41.39169869775547),
  long = c(2.196738000726682, 2.174350603195429, 2.1228167602398784, 2.1649159045942996)
)

harbour_space <- locations %>% filter(name == "Harbour Space, Campus Barcelona")

bbox_fixed <- c(left = 2.074996458120354, bottom = 41.35855565204186, right = 2.2340404052210623, top = 41.41567063398011)

BCN_TILE <- get_stadiamap(bbox = bbox_fixed, zoom = 14, maptype = "stamen_toner", crop = TRUE, messaging = FALSE)
BCN_TILE <- ggmap(BCN_TILE)
```

```{r}
compute_routes <- function(src_coords, dst_coords) {
  list(
    car = osrmRoute(src = src_coords, dst = dst_coords, osrm.profile = "car"),
    foot = osrmRoute(src = src_coords, dst = dst_coords, osrm.profile = "foot")
  )
}

routes <- lapply(1:nrow(locations), function(i) {
  if (locations$name[i] != "Harbour Space, Campus Barcelona") {
    compute_routes(
      src_coords = c(harbour_space$long, harbour_space$lat),
      dst_coords = c(locations$long[i], locations$lat[i])
    )
  }
})

map_list <- lapply(1:length(routes), function(i) {
  if (!is.null(routes[[i]])) {
    car_sf <- st_as_sf(routes[[i]]$car)
    foot_sf <- st_as_sf(routes[[i]]$foot)
    place_name <- locations$name[i]
    
    BCN_TILE +
      geom_sf(data = car_sf, aes(color = "Car"), linewidth = 3, inherit.aes = FALSE) +
      geom_sf(data = foot_sf, aes(color = "Foot"), linewidth = 3, inherit.aes = FALSE) +
      labs(title = paste("Routes from Harbour Space to", place_name)) +
      theme_void() +
      theme(
        plot.title = element_text(vjust = 3, hjust = 0.1, size = 30, color = "black"),
        plot.background = element_rect(fill = "#bebebe", color = NA),
        legend.background = element_rect(fill = "white", color = "black", size = 4),
        legend.text = element_text(size = 15, color = "black"),
        legend.title = element_text(size = 20, face = "bold", color = "black", vjust = 1),
        legend.key.width = unit(1, "cm"),
        legend.spacing.y = unit(0.2, "cm"),
        legend.position = c(1, 0.1), 
        legend.justification = c(1.1, 0),
        legend.title.align = 0.5,
        legend.margin = margin(1, 1, 1, 1, "cm"),
        plot.margin = unit(c(1, 0, 0, 0), "cm")
      ) +
      guides(colour = guide_legend(title = "Route Type")) +
      scale_color_manual(name = "Route Type", values = c("Car" = "red", "Foot" = "#11f3ff"))
  }
})

map_list <- map_list[!sapply(map_list, is.null)]

gtable_maps <- do.call(rbind, lapply(map_list, function(x) ggplotGrob(x)))

ggsave("routes_combined.png", plot = gtable_maps, scale = 1, height = 23, width = 14, units = "in", limitsize = FALSE)
```